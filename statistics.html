<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据统计</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        .datetime-picker {
            margin: 10px;
        }
        .chart-container {
            margin: 20px;
        }
        canvas {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <h1>数据统计</h1>
    <div class="datetime-picker">
        <label for="start-time">开始时间:</label>
        <input type="datetime-local" id="start-time" name="start-time">
    </div>
    <div class="datetime-picker">
        <label for="end-time">结束时间:</label>
        <input type="datetime-local" id="end-time" name="end-time">
    </div>
    <!-- 添加时间轴尺度选择 -->
    <div class="datetime-picker">
        <label for="scale">时间轴尺度:</label>
        <select id="scale" name="scale">
            <option value="minute">分钟</option>
            <option value="hour">小时</option>
            <option value="day">天</option>
        </select>
    </div>
    <button class="export-button" onclick="fetchStatisticsData()">生成统计图</button>
    <!-- 添加导出图片的按钮 -->
    <button class="export-button" onclick="exportChartAsImage()">导出图片</button>
    <!-- 添加生成拟合曲线的按钮 -->
    <button class="export-button" onclick="generateSmoothCurve()">生成拟合曲线</button>

    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
        <canvas id="humidityChart"></canvas>
        <canvas id="soilMoistureChart"></canvas>
        <canvas id="soilNutrientChart"></canvas>
    </div>

    <script>
        function fetchStatisticsData() {
            const start_time = document.getElementById('start-time').value;
            const end_time = document.getElementById('end-time').value;
            const scale = document.getElementById('scale').value; // 添加时间轴尺度参数

            if (!start_time || !end_time) {
                alert("请提供开始时间和结束时间");
                return;
            }

            fetch(`/get_statistics_data?start_time=${encodeURIComponent(start_time)}&end_time=${encodeURIComponent(end_time)}&scale=${encodeURIComponent(scale)}`) // 添加时间轴尺度参数
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) { // 检查数据是否为空
                        alert("没有找到对应时间范围内的数据");
                        return;
                    }

                    // 确保时间戳转换为可识别的格式
                    const timestamps = data.map(item => new Date(item.timestamp).getTime());
                    const temperatures = data.map(item => item.temperature);
                    const humidities = data.map(item => item.humidity);
                    const soilMoistures = data.map(item => item.soil_moisture);
                    const soilNutrients = data.map(item => item.soil_nutrient);

                    // 温度折线图
                    drawLineChart('temperatureChart', timestamps, temperatures, '空气温度 (°C)', 'rgba(75, 192, 192, 1)');

                    // 湿度折线图
                    drawLineChart('humidityChart', timestamps, humidities, '空气湿度 (%)', 'rgba(153, 102, 255, 1)');

                    // 土壤湿度折线图
                    drawLineChart('soilMoistureChart', timestamps, soilMoistures, '土壤湿度 (%)', 'rgba(255, 99, 132, 0.2)');

                    // 土壤营养成分折线图
                    drawLineChart('soilNutrientChart', timestamps, soilNutrients, '土壤营养成分', 'rgba(54, 162, 235, 0.2)');
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // 修改导出图片的函数以包含时间轴尺度参数
        function exportChartAsImage() {
            const start_time = document.getElementById('start-time').value;
            const end_time = document.getElementById('end-time').value;
            const scale = document.getElementById('scale').value;

            if (!start_time || !end_time) {
                alert("请提供开始时间和结束时间");
                return;
            }

            const url = `/export_chart?start_time=${encodeURIComponent(start_time)}&end_time=${encodeURIComponent(end_time)}&scale=${encodeURIComponent(scale)}`;
            window.location.href = url;
        }

        // 添加生成拟合曲线的函数
        function generateSmoothCurve() {
            const start_time = document.getElementById('start-time').value;
            const end_time = document.getElementById('end-time').value;
            const scale = document.getElementById('scale').value;

            if (!start_time || !end_time) {
                alert("请提供开始时间和结束时间");
                return;
            }

            const url = `/export_smooth_chart?start_time=${encodeURIComponent(start_time)}&end_time=${encodeURIComponent(end_time)}&scale=${encodeURIComponent(scale)}`;
            window.location.href = url;
        }

        function drawLineChart(canvasId, labels, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // 清除画布
            ctx.beginPath();
            ctx.moveTo(0, ctx.canvas.height - (data[0] / Math.max(...data)) * ctx.canvas.height);

            for (let i = 1; i < labels.length; i++) {
                const x = (i / labels.length) * ctx.canvas.width;
                const y = ctx.canvas.height - (data[i] / Math.max(...data)) * ctx.canvas.height;
                ctx.lineTo(x, y);
            }

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.font = '12px Arial';
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';

            for (let i = 0; i < labels.length; i++) {
                const x = (i / labels.length) * ctx.canvas.width;
                const y = ctx.canvas.height - (data[i] / Math.max(...data)) * ctx.canvas.height;
                ctx.fillText(data[i], x, y - 5);
            }
        }

    </script>
</body>
</html>